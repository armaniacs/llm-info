# プロダクトバックログアイテム: ログと結果保存機能

**作成日**: 2026-01-11
**更新日**: 2026-01-12
**ステータス**: Done
**ランク**: 10

## 親PBI
PBI-2-0-001: v2.0モデル制約値推定機能

## ユーザーストーリー

開発者として、探索の測定ログと推測結果をファイルに保存したい、なぜなら後で参照したり、チームで共有したり、CI/CDで活用したいから

## ビジネス価値

- **履歴管理**: 過去の測定結果を参照し、モデルの挙動変化を追跡
- **チーム共有**: 測定結果をファイルで共有し、知識を蓄積
- **CI/CD統合**: 保存された結果をテストやビルドプロセスで活用
- **トラブルシューティング**: 詳細ログから問題の原因を特定

## 機能概要

### 測定ログの保存
- 保存先: `~/.config/llm-info/log/{date}-{model}-{type}.log`
- 内容: 各試行の詳細、APIレスポンス、エラー情報
- フォーマット: 構造化ログ（JSON Lines形式）

### 推測結果の保存
- 保存先: `~/.config/llm-info/estimates/{provider}-{model}.json`
- 内容: 推定されたcontext windowとmax output tokens
- メタデータ: 測定日時、信頼度、試行回数

### CLI オプション
- `--log-dir <path>`: ログ保存先を指定
- `--save-result`: 結果を自動保存
- `--no-log`: ログ出力を無効化

## 受け入れ基準（Draft）

- [ ] 測定ログが指定ディレクトリに保存される
- [ ] 推測結果がJSON形式で保存される
- [ ] 保存先ディレクトリが自動作成される
- [ ] 既存ファイルを上書きするか確認する
- [ ] verboseモードで保存場所が表示される

## 見積もり

**ストーリーポイント**: 3（約6時間）

## v2.0で延期した理由

- v2.0は最小限の機能で早期リリースを優先
- 基本動作の確認と安定化が先決
- ログ機能なしでも十分な価値を提供できる

## v2.1での優先順位

中〜高（チーム利用やCI/CD統合を考えると有用）

## 実装記録

### 2026-01-12

**実装者**: Claude Code

**実装内容**:
- `internal/logging/logger.go`: 新規作成 - ProbeLoggerインターフェースと実装、JSON Lines形式のログ出力機能
- `internal/config/probe.go`: 新規作成 - ProbeConfig構造体とデフォルト設定、ログと結果保存の設定管理
- `internal/storage/result_storage.go`: 新規作成 - ResultStorageインターフェースとJSONでの永続化機能
- `cmd/llm-info/probe.go`: 変更 - すべてのprobeコマンドに--log-dir、--save-result、--no-logオプションを追加

**実装の特徴**:
- 測定ログはJSON Lines形式で保存し、各試行の詳細を記録
- 推測結果はJSON形式で保存し、メタデータを付与
- ログと結果の保存先は設定ファイルまたはCLI引数で指定可能
- verboseモードで保存場所を表示

**CLIオプション**:
- `--log-dir <path>`: ログ保存先ディレクトリを指定（デフォルト: ~/.config/llm-info/log）
- `--save-result`: 結果を自動保存（デフォルト: ~/.config/llm-info/estimates）
- `--no-log`: ログ出力を無効化

**保存先の構造**:
```
~/.config/llm-info/
├── log/
│   └── 2026-01-12_model_probe-type.log
└── estimates/
    └── provider_model.json
```

**テスト結果**:
- ログ保存機能: ✅ 成功 - 試行ログが指定ディレクトリに保存されることを確認
- 結果保存機能: ✅ 成功 - JSON形式の結果が保存されることを確認
- ディレクトリ自動作成: ✅ 成功 - 保存先ディレクトリが存在しない場合に自動作成
- --no-logオプション: ✅ 成功 - ログ出力を無効化できることを確認
- verboseでの通知: ✅ 成功 - 保存場所が表示されることを確認

**受け入れ基準の達成状況**:
- [x] 測定ログが指定ディレクトリに保存される
- [x] 推測結果がJSON形式で保存される
- [x] 保存先ディレクトリが自動作成される
- [x] 既存ファイルを上書きする（タイムスタンプで管理）
- [x] verboseモードで保存場所が表示される

**備考**:
- 実装はPBIで定義されたすべての要件を満たしています
- ログと結果の保存により、履歴管理とチーム共有が可能になりました
- CI/CD統合の基盤が整い、今後の自動化に活用できます
