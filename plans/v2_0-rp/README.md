# v2.0 モデル制約値推定機能 PBI一覧

## 概要

このフォルダには、llm-info v2.0で実装するモデル制約値推定機能のプロダクトバックログアイテム（PBI）が格納されています。

ryuzee式の垂直分割 + BDD（ビヘイビアドリブン開発） + t_wadaスタイルのテスト駆動開発を統合したアプローチで設計されています。

## 物語

LLMの真の実力は公式ドキュメントでは語られない。APIの実挙動から密かにその限界を探り出す探偵ツールがここに生まれる。開発者は正確な制約値という羅針盤を手に、未開のAIアプリケーションへと航海できるのだ。

## PBI一覧

### プログレッション（実装順）

1. **PBI-2-0-001: v2.0モデル制約値推定機能** [master]
   - 全体像とビジネス価値の定義
   - 分割計画と技術的方針

2. **PBI-2-0-002: 技術調査 - OpenAI API基本連携** [spike]
   - 最も重要な技術的不確実性の解消
   - API連携の土台構築
   -「ここで絶対に失敗させない」設計

3. **PBI-2-0-003: Context Window推定アルゴリズム実装**
   - コア機能の実装
   - 二分探索とテストデータ生成
   -「Intelligence Exhaustion」を避ける知恵

4. **PBI-2-0-004: Max Output Tokens推定実装**
   - 二番目の制約値の実装
   - APIレスポンス観測による推定
   - 予期せぬ打ち切りとの戦い

### 今後の拡張（v2.1で検討）

5. ~~PBI-2-0-005: 出力形式とUX改善~~
6. ~~PBI-2-0-006: Needle In A Haystack機能~~
7. ~~PBI-2-0-007: パフォーマンス最適化とエラーハンドリング~~

### 今後やること(v2.0を出す前にやること)

#### ✅ 完了済み (2026-01-11)
- **PBI-2-0-002**: OpenAI API基本連携のspike実装完了
  - probeコマンドの実装
  - v1/chat/completionsエンドポイント対応
  - 基本的なAPI呼び出し機能確認

- **PBI-2-0-003**: Context Window推定アルゴリズム実装完了
  - TestDataGenerator：青空文庫テキストを使用
  - BoundarySearcher：指数探索と二分探索
  - ContextWindowProbe：探索ロジック統合
  - probe-contextコマンド実装

- **PBI-2-0-004**: Max Output Tokens推定実装完了
  - MaxOutputTokensProbe：256からの探索開始
  - バリデーションエラーとincomplete status検出
  - probe-max-outputコマンド実装

#### 🔄 現在の問題点
- API呼び出しの実装問題："Probing..."出力後に処理が停止
  - 根本原因: context.Background()にタイムアウトなし（調査完了）
  - 根本原因: response.Usageへのnilチェックなし（調査完了）
- BoundarySearcherのAPI間隔設定（現在0.5秒、テスト用に10回まで減少）

#### 📋 v2.0で実装すべきPBI（最小限の機能で早期リリース）

**フェーズ1: 緊急修正（ブロッカー）**

1. **PBI-2-0-005: API呼び出しタイムアウト問題の修正**（最高優先度）
   - 見積もり: 1SP（約75分）
   - 内容: context.WithTimeoutの追加、nilチェック追加
   - ファイル: `PBI-2-0-005-fix-api-timeout.md`
   - 目的: ツールを実用可能にする

**フェーズ2: UX改善**

2. **PBI-2-0-006: テーブル形式での結果出力**
   - 見積もり: 2SP（約4時間）
   - 内容: 見やすいテーブル形式での結果表示
   - ファイル: `PBI-2-0-006-table-output.md`
   - 目的: CLI直接確認を容易にする

**v2.0リリース判定基準**:
- [ ] PBI-2-0-005完了（probe コマンドが動作する）
- [ ] PBI-2-0-006完了（結果がテーブル形式で表示される）
- [ ] 実際のAPIでE2Eテストが成功する
- [ ] ドキュメントが更新されている

#### 📌 v2.1以降に延期するPBI

以下の機能は v2.0 では実装せず、v2.1以降で検討します：

3. **PBI-2-1-001: ログと結果保存機能**
   - 見積もり: 3SP
   - ファイル: `PBI-2-1-001-log-save.md`
   - 理由: 基本動作の確認と安定化が先決

4. **PBI-2-1-002: 統合機能（同時実行とマージ）**
   - 見積もり: 2SP
   - ファイル: `PBI-2-1-002-integration.md`
   - 理由: 個別実行でも十分な価値を提供

5. **PBI-2-1-003: JSON形式での出力**
   - 見積もり: 2SP
   - ファイル: `PBI-2-1-003-json-output.md`
   - 理由: テーブル形式で十分

6. **PBI-2-1-004: Needle In A Haystack機能**
   - 見積もり: 3SP
   - ファイル: `PBI-2-1-004-needle-haystack.md`
   - 理由: 高度な検証機能、必須ではない

7. **PBI-2-1-005: 詳細なverboseログ出力**
   - 見積もり: 2SP
   - ファイル: `PBI-2-1-005-verbose-log.md`
   - 理由: 基本的なverboseで十分

8. **PBI-2-1-006: API使用量計算とコスト警告**
   - 見積もり: 3SP
   - ファイル: `PBI-2-1-006-cost-warning.md`
   - 理由: 初期ユーザーは手動管理可能

## 開発ガイドライン

### Outside-Inアプローチ

1. **外側（CLI/UX）から**: ユーザーが触れる部分から着手
2. **中間（API）**: 外部システムとの境界
3. **内側（ビジネスロジック）**: アルゴリズムの核心

### テスト戦略

```
テストピラミッド:
    E2Eテスト (1)
   ↗
  統合テスト (10)
 ↗
単体テスト (100)
```

### TDDサイクル

1. **Red**: まだ存在しない機能の失敗テスト
2. **Green**: 最小限の実装でテストを通す
3. **Refactor**: 内部を綺麗にしながら性質を保つ

## 共通の理念

### 勝利の定義

「実行し、信頼でき、価値がある」- これが全てのPBIが目指す状態

* 実行できる: ボタン一つで動く
* 信頼できる: 結果が再現可能
* 価値がある: 実際に使える情報を提供

### アンチパターン

❌ フロントエンドとバックエンドの分割
❌ MySQLとGoの分離
❌ 「要因分析」と「対策」の分離

### 品質の誓約

- 全てのBDDシナリオが自動テストでパス
- テストカバレッジ90%以上
- レビュー必須
- リファクタリング継続

## 実装の原則

### Simple is Better

- スパイク（技術調査）で最も重要な不確実性を解消
- ハッピーパスから固める
- 複雑さは後から追加できるが、シンプルさは後から取り戻せない

### 実用主義

- 完璧な正確性より実用上十分な精度を優先
- 誤差目標：±5%（大半のユースケースで十分な精度）
- 開発者の実際の課題解決に焦点
- 学術的研究ツールではない

### 経済性

- 平均的なモデルで$0.05以内
- APIレート制限を尊重
- 必要以上の探索は行わない

## 用語集

| 用語 | 意味 |
|------|------|
| **Context Window** | 入力と出力の合計トークン上限 |
| **Max Output Tokens** | 1回の応答で生成可能な最大トークン数 |
| **Needle In A Haystack** | 長文の中の特定情報を検出するテスト手法 |
| **Boundary Search** | 境界値を効率的に見つける探索アルゴリズム |
| **Outside-In** | 外側から内側へのテスト駆動開発アプローチ |

## 成功のメトリクス

### 技術メトリクス

- APIコール回数: ≤ 55回/モデル
- 実行時間: ≤ 120秒
- メモリ使用量: ≤ 100MB
- エラー率: < 1%
- 推定精度: ±5%（誤差128トークン以内を満たす範囲で）

### ビジネスメトリクス

- 手動調査時間: 1時間 → 5分
- Context Overflowエラー: 90%削減
- 採用モデル数: 初期3モデル → 全モデル

## そして旅は続く

ここでは1つの物語が終わる時、次の物語が始まる準備ができている。

tiktokenによる事前計算、複数モデルの一括測定、そしてまだ見ぬ最適化の地平線へ。

---

*「最高のテストは、実世界そのものである」- t_wada*
*「垂直分割の美は、価値の流れにある」- ryuzee*
*「振る舞いは仕様であり、仕様はテストである」- BDD*